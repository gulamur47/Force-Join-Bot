import logging
import os
import threading
from http.server import HTTPServer, BaseHTTPRequestHandler
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import Application, CommandHandler, ContextTypes, CallbackQueryHandler

# --- Render Port Fix ---
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.end_headers()
        self.wfile.write(b"Bot is running!")

def run_health_check_server():
    port = int(os.environ.get("PORT", 8000))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    server.serve_forever()

threading.Thread(target=run_health_check_server, daemon=True).start()

# --- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ---
TOKEN = '8510787985:AAHjszZmTMwqvqTfbFMJdqC548zBw4Qh0S0' 
WATCH_NOW_URL = "https://mmshotbd.blogspot.com/?m=1"

# ‡¶®‡¶§‡ßÅ‡¶® ‡ßß‡ßß‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ (ID/Username ‡¶è‡¶¨‡¶Ç Invite Link)
CHANNELS_DATA = [
    {"id": "@virallink259", "name": "‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶¶‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡ß®‡ß¶‡ß®‡ß¨üî•‚ù§Ô∏è", "link": "https://t.me/virallink259"},
    {"id": -1002279183424, "name": "Primium App Zone", "link": "https://t.me/+5PNLgcRBC0IxYjll"}, # Private
    {"id": "@virallink246", "name": "Bd beauty viral", "link": "https://t.me/virallink246"},
    {"id": "@viralexpress1", "name": "Facebooküî• Instagram Linküî•", "link": "https://t.me/viralexpress1"},
    {"id": "@movietime467", "name": "üé¨MOVIEüî• TIMEüí•", "link": "https://t.me/movietime467"},
    {"id": "@viralfacebook9", "name": "BD MMS VIDEOüî•üî•", "link": "https://t.me/viralfacebook9"},
    {"id": "@viralfb24", "name": "‡¶¶‡ßá‡¶∂‡¶ø ‡¶≠‡¶æ‡¶¨‡¶ø ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤üî•ü•µ", "link": "https://t.me/viralfb24"},
    {"id": "@fbviral24", "name": "‡¶ï‡¶ö‡¶ø ‡¶Æ‡ßá‡ßü‡ßá‡¶¶‡ßá‡¶∞ ‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶¶‡¶ø‡¶ìüî•", "link": "https://t.me/fbviral24"},
    {"id": -1001550993047, "name": "‡¶≠‡¶æ‡¶á‡¶∞‡¶æ‡¶≤ ‡¶≠‡¶ø‡¶¶‡¶ø‡¶ì ‡¶∞‡¶ø‡¶ï‡ßÅ‡ßü‡ßá‡¶∑‡ßç‡¶üü•µ", "link": "https://t.me/+WAOUc1rX6Qk3Zjhl"}, # Private
    {"id": -1002011739504, "name": "Viral Video BD üåçüî•", "link": "https://t.me/+la630-IFwHAwYWVl"}, # Private
    {"id": -1002444538806, "name": "Ai Prompt Studio üé®üì∏", "link": "https://t.me/+AHsGXIDzWmJlZjVl"} # Private
]

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

async def check_all_joined(user_id, context):
    not_joined = []
    for channel in CHANNELS_DATA:
        try:
            member = await context.bot.get_chat_member(chat_id=channel["id"], user_id=user_id)
            if member.status not in ['member', 'administrator', 'creator']:
                not_joined.append(channel)
        except Exception as e:
            # ‡¶Ø‡¶¶‡¶ø ‡¶¨‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá ‡¶è‡¶∞‡¶∞ ‡¶¶‡¶ø‡¶¨‡ßá, ‡¶§‡¶ñ‡¶® ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ß‡¶∞‡ßá ‡¶®‡ßá‡¶¨ ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡¶ø
            not_joined.append(channel)
    return not_joined

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id
    stylish_name = f"üë§ <b>{user.first_name}</b>"
    
    not_joined_list = await check_all_joined(user_id, context)

    if not not_joined_list:
        success_text = (
            f"üéâ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ {stylish_name}\n"
            f"‚úÖ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá Join ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‚ù§Ô∏è\n"
            f"‚ñ∂Ô∏è ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶è‡¶ñ‡¶®‡¶á <b>[Watch Now]</b> ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® üé¨‚ú®"
        )
        watch_kb = [[InlineKeyboardButton("Watch Now üé¨", url=WATCH_NOW_URL)]]
        await update.message.reply_text(success_text, reply_markup=InlineKeyboardMarkup(watch_kb), parse_mode=ParseMode.HTML)
    else:
        buttons = []
        for channel in not_joined_list:
            buttons.append([InlineKeyboardButton(f"Join {channel['name']}", url=channel['link'])])
        
        buttons.append([InlineKeyboardButton("Check Joined ‚úÖ", callback_data="check_status")])
        
        caption = (
            f"Hello {stylish_name},\n\n"
            "üö® <b>Attention Please!</b>\n\n"
            "Viral ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ Channel ‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá Join ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶æ‡¶ß‡ßç‡¶Ø‡¶§‡¶æ‡¶Æ‡ßÇ‡¶≤‡¶ï‡•§\n"
            "‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ Join ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ ‚ùå\n\n"
            "Join ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá <b>Check Joined</b> ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‚úÖ"
        )
        await update.message.reply_text(caption, reply_markup=InlineKeyboardMarkup(buttons), parse_mode=ParseMode.HTML)

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    stylish_name = f"<b>{user.first_name}</b>"
    not_joined_list = await check_all_joined(user.id, context)
    
    if not not_joined_list:
        await query.answer(f"‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶ {user.first_name}! ‡¶∏‡¶¨ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", show_alert=True)
        success_text = (
            f"üéâ ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ {stylish_name}\n"
            f"‚úÖ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá Join ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‚ù§Ô∏è\n"
            f"‚ñ∂Ô∏è ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶è‡¶ñ‡¶®‡¶á <b>[Watch Now]</b> ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® üé¨‚ú®"
        )
        watch_kb = [[InlineKeyboardButton("Watch Now üé¨", url=WATCH_NOW_URL)]]
        await query.edit_message_text(success_text, reply_markup=InlineKeyboardMarkup(watch_kb), parse_mode=ParseMode.HTML)
    else:
        await query.answer("‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡¶ì ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø! ‡¶∏‡¶¨ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", show_alert=True)

if __name__ == '__main__':
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_callback))
    print("Bot is running with 11 channels on Render...")
    app.run_polling()
